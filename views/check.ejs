<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Motivation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="apple-touch-icon" href="/docs/5.3/assets/img/favicons/apple-touch-icon.png" sizes="180x180">
</head>
<body class="text-light" style="background-color: rgb(34,34,34); font-family: 'Roboto Condensed', sans-serif;">

<!-- Nav -->
<header class="p-3 text-bg-dark">
  <div class="container">
    <div class="d-flex mx-5 flex-wrap align-items-center justify-content-center justify-content-lg-start">
      <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 mx-5 px-5 justify-content-center mb-md-0">
        <li><a href="#" class="nav-link px-3 mx-2 text-secondary">About the course</a></li>
        <li><a href="#" class="nav-link px-3 mx-2 text-white">Features</a></li>
        <li><a href="#" class="nav-link px-3 mx-2 text-white">Training format</a></li>
        <li><a href="#" class="nav-link px-3 mx-2 text-white">Reviews</a></li>
        <li><a href="#" class="nav-link px-3 mx-2 text-white">Media</a></li>
      </ul>
      <div class="text-end">
        <button type="button" class="btn btn-success btn-lg">Start Learning</button>
      </div>
    </div>
  </div>
</header>

<!-- 2FA Section -->
<div class="container mt-4">
  <% if (user && user.twoFactorEnabled) { %>
    <button class="btn btn-danger" id="disable2FA">Disable 2FA</button>
  <% } else { %>
    <button class="btn btn-primary" id="enable2FA">Enable 2FA</button>
    <div id="2faSetup" style="display: none;" class="mt-3">
      <h4>Scan this QR code with your authenticator app:</h4>
      <img id="qrCodeImage" src="" alt="QR Code">
      <p>If you can't scan the code, enter this secret manually: <span id="manualCode"></span></p>
      <label for="2faCode">Enter the 6-digit code from your authenticator app:</label>
      <input type="text" id="2faCode" class="form-control w-25 my-2" placeholder="Enter 6-digit code">
      <button class="btn btn-success" id="confirm2FA">Confirm</button>
    </div>
  <% } %>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const userId = "<%= user ? user._id : '' %>";

    if (!userId) {
      console.warn("User ID is missing. 2FA features will not work.");
      return;
    }

    const enable2FAButton = document.getElementById("enable2FA");
    const confirm2FAButton = document.getElementById("confirm2FA");
    const disable2FAButton = document.getElementById("disable2FA");

    if (enable2FAButton) {
      enable2FAButton.addEventListener("click", async () => {
        try {
          const response = await fetch(`/api/enable-2fa/${userId}`);
          const result = await response.json();

          if (!response.ok) {
            alert(result.msg);
            return;
          }

          document.getElementById("qrCodeImage").src = result.qrCode;
          document.getElementById("manualCode").textContent = result.manualEntryCode;
          document.getElementById("2faSetup").style.display = "block";
        } catch (error) {
          console.error("Error fetching 2FA setup:", error);
          alert("An error occurred while setting up 2FA.");
        }
      });
    }

    if (confirm2FAButton) {
      confirm2FAButton.addEventListener("click", async () => {
        const code = document.getElementById("2faCode").value;

        if (!code || code.length !== 6) {
          alert("Please enter a valid 6-digit code.");
          return;
        }

        try {
          const response = await fetch(`/api/enable-2fa/${userId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code }),
          });
          const result = await response.json();

          if (response.ok) {
            alert("2FA enabled successfully!");
            window.location.reload();
          } else {
            alert(result.msg);
          }
        } catch (error) {
          console.error("Error enabling 2FA:", error);
          alert("An error occurred while enabling 2FA.");
        }
      });
    }

    if (disable2FAButton) {
      disable2FAButton.addEventListener("click", async () => {
        try {
          const response = await fetch(`/api/disable-2fa/${userId}`, {
            method: "POST",
          });
          const result = await response.json();

          if (response.ok) {
            alert("2FA disabled successfully!");
            window.location.reload();
          } else {
            alert(result.msg);
          }
        } catch (error) {
          console.error("Error disabling 2FA:", error);
          alert("An error occurred while disabling 2FA.");
        }
      });
    }
  });
</script>

</body>
</html>
